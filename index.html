<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.5.0/axios.min.js"
    integrity="sha512-aoTNnqZcT8B4AmeCFmiSnDlc4Nj/KPaZyB5G7JnOnUEkdNpCZs1LCankiYi01sLTyWy+m2P+W4XM+BuQ3Q4/Dg=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.6.1/toastify.js"
    integrity="sha512-MnKz2SbnWiXJ/e0lSfSzjaz9JjJXQNb2iykcZkEY2WOzgJIWVqJBFIIPidlCjak0iTH2bt2u1fHQ4pvKvBYy6Q=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"
    integrity="sha512-Xm9qbB6Pu06k3PUwPj785dyTl6oHxgsv9nHp7ej7nCpAqGZT3OZpsELuCYX05DdonFpTlBpXMOxjavIAIUwr0w=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <!-- <script defer src="app.js"></script> -->
  <script>
    // import Swal from 'sweetalert2'
    const socket = io('ws://localhost:5000', { transports: ['websocket'] });
    socket.on('connection', () => {
      console.log('@client: connected to socket io..')
    })

    socket.on('notification', (data) => {
      console.log('@client | Dispaly notification from server :', data.userId, 'message :', data.msg);
      const Swal = require('sweetalert2');
      Swal.fire({
        title: 'Successfully logged in',
        text: 'Do you want to continue',
        icon: 'error',
        confirmButtonText: 'OK'
      });

    })

    socket.on('login-success', (data) => {
      console.log('@SERVER SAID: ', data);
      Swal.fire({
        title: data,
        text: data,
        icon: 'success',
        confirmButtonText: 'OK'
      });
    })
  </script>

  <title>Login | Anthropologyca </title>
  <style>
    #loginForm {
      height: 500px;
      width: 600px;
      margin-top: 15%;
      margin-right: 25%;
      display: flex;
      flex-direction: column;
    }

    input {
      height: 30px;
      margin: 10px;
    }

    .comment {
      width: 100%;
      height: 100px;
      padding: 10px;
    }

    #notification-icon {
      width: 25px;
      height: 25px;
    }
  </style>
</head>

<body>
  <form id="loginForm" action="">
    <input id="email" type="text" placeholder="email">
    <input id="password" type="password" placeholder="password">
    <input id="loginBtn" type="submit" value="login">
  </form>
</body>
<script>

  const loginBtn = document.getElementById("loginBtn");
  const email = document.getElementById("email");
  const password = document.getElementById("password");
  loginBtn.addEventListener('click', (e) => {
    e.preventDefault();
    axios({
      method: 'post',
      url: 'http://127.0.0.1:5000/api/v1/users/login',
      data: {
        email: email.value,
        password: password.value
      }
    }).then(res => {
      socket.emit('login', { userId: res.data.data.user._id, message: 'loggginnnnnnn' });
      // socket.emit('login', res.data.data.user.id, 'loggginnnnnnn');

      console.log(res);
      document.getElementById("loginForm").remove();
      const resp = axios({
        method: 'get',
        url: 'http://127.0.0.1:5000/api/v1/posts/',
      }).then(resp => {

        // const notificationDiv = document.createElement('div');

        // const notificationIcon = document.createElement('img');
        // notificationIcon.setAttribute('src', 'public/img/notification-bell.png')
        // notificationIcon.setAttribute('id', 'notification-icon');

        // notificationDiv.appendChild(notificationIcon);


        const posts = resp.data.data.docs;
        console.log(resp)
        const section = document.createElement('section');

        posts.forEach(post => {
          const div = document.createElement('div')
          div.setAttribute("id", post._id)
          div.classList.add('article')

          const title = document.createElement('h3')
          title.innerHTML = post.title
          div.appendChild(title)

          const p = document.createElement('p')
          p.innerHTML = post.summary
          div.appendChild(p)

          const commentForm = document.createElement('form')
          // commentForm.method = "Post"
          // commentForm.action = `http://127.0.0.1:5000/api/v1/${post._id}/comments/`

          const textArea = document.createElement('textarea')
          textArea.name = "comment"

          const commentBtn = document.createElement('button')
          commentBtn.type = "submit"
          commentBtn.innerHTML = "اضافة تعليق"

          const userInput = document.createElement('input')
          userInput.type = "hidden"
          userInput.name = "user"
          userInput.value = "64d399f762b2cac5242104f7"


          // const postInput = document.createElement('input')
          // postInput.type = "hidden"
          // userInput.name = "post"
          // postInput.value = post._id

          commentForm.appendChild(textArea)
          commentForm.appendChild(userInput)
          // commentForm.appendChild(postInput)
          commentForm.appendChild(commentBtn)



          div.appendChild(commentForm)



          section.appendChild(div);
          // console.log(post.title);

          commentBtn.addEventListener('click', async (e) => {
            e.preventDefault()
            // axios({
            //   method: 'post',
            //   url: `http://127.0.0.1:5000/api/v1/${post._id}/comments/`,
            //   data: {
            //     user: "64d399f762b2cac5242104f7",
            //     post: post._id,
            //     comment: "thisi is a coment",
            //   }
            await axios.post(`http://127.0.0.1:5000/api/v1/comments/`, {
              user: "64d399f762b2cac5242104f7",
              post: "64d92ec846052d8465a1d041",
              comment: "this is a coment",
            }
            ).then(res => {
              console.log(res)
            })

          });
          // document.body.appendChild(notificationDiv);
          document.body.appendChild(section);

        });

        // }).then(result => {
        //   const docs = result.data.docs;
        //   console.log(docs)
        //   // docs.forEach(post => {
        //   //   document.createElement('p').innerHTML = post.title;
        //   // });
        // })

        // console.log(resp.data.data.images)
        // console.log(resp.data.data.streamImages)

        // resp.data.data.streamImages.arrayBuffer().then(buffer => {
        //   const image = new Blob([buffer], { type: 'image/jpeg' });
        //   const imageUrl = URL.createObjectURL(image);

        //   // Set the data URL as the image source
        //   const imgTag = document.createElement('img').src = imageUrl;
        //   document.body.appendChild(imgTag);
        // })
        //   .catch(error => console.error('Error fetching image:', error));


        // console.log(`userId${res.data.data.user._id}`)
        // socket.emit('login', res.data.data.user._id, '@client message : Login Attempt ');
      });
    });
  });

</script>

</html>